.build_docker_image: &build-docker-image
  - echo "building $DOCKER_BUILD_DIR"
  - git checkout -B $CI_COMMIT_BRANCH $CI_COMMIT_SHA
  - cp -r .gitlab/ci/ci_resources "$DOCKER_BUILD_DIR/ci_resources"
  - gcloud auth configure-docker --quiet ${DOCKER_IO_DOMAIN}
  - docker build $DOCKER_BUILD_DIR -t "test/$DOCKER_BUILD_DIR" --build-arg=DOCKER_IO=${DOCKER_IO}

.create_image: &create-image
  - |
    echo "Pipeline source:$CI_PIPELINE_SOURCE"
    echo "Build type:$BUILD_TYPE"
    export BUILD_NUMBER=$(echo "$INSTALLER_URL" | grep -o -E "\-[0-9]+/" | grep -o -E "[0-9]+")
    echo "BUILD_NUMBER: ${BUILD_NUMBER}"
    export SERVER_IMG_NAME="server-image-$VERSION-$BUILD_NUMBER-$(date -u +"%Y-%m-%d")"
    echo "SERVER_IMG_NAME: ${SERVER_IMG_NAME}"
    export BASE_INSTANCE_NAME="template-${CI_PIPELINE_ID}-${SERVER_IMG_NAME}"
    echo "BASE_INSTANCE_NAME: ${BASE_INSTANCE_NAME}"
    echo "INSTALLER_URL: ${INSTALLER_URL}"
    export DOCKER_BUILD_DIR="server-image-build"
  - *build-docker-image
  - ./server-image-build/run.sh

.build-images-dev-rule:
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger)$/ && $BUILD_TYPE == "BUILD_SERVER_DEV_IMAGE"'

.build-images-dev-rule-always:
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger)$/ && $BUILD_TYPE == "BUILD_SERVER_DEV_IMAGE"'
      when: always

.build-images-ga-rule:
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger)$/ && $BUILD_TYPE == "BUILD_SERVER_GA_IMAGE"'

.build-images-ga-rule-always:
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger)$/ && $BUILD_TYPE == "BUILD_SERVER_GA_IMAGE"'
      when: always

.docker-job:
  tags:
    - gce
  before_script:
    - until docker info &> /dev/null; do sleep 1; done
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  extends:
    - .docker_services


.config-pip:
  before_script:
    - cp .gitlab/ci/ci_resources/pip.conf /etc/pip.conf

build-images-dev:
  stage: build-server-images
  needs: []
  extends:
    - .build-images-dev-rule # put in comment for testing
    - .docker-job
  script:
    - gcloud auth activate-service-account --key-file $XSOAR_SERVER_STORAGE_CREDS --quiet
    - export VERSION="master"
    - export LAST_SUCCESS_BUILD_PATH=$(gsutil ls -d "gs://xsoar-ci-artifacts-server/server/dev-6-??????/0/ci_status_success" | tail -n 1 | grep -o -E "gs://xsoar-ci-artifacts-server/server/dev-6-[0-9]+/0")
    - export INSTALLER_URL="xsoar-ci-artifacts-server/$(gsutil ls -d "$LAST_SUCCESS_BUILD_PATH/demistoserver-*.sh" | grep -o -E "server/dev-6-[0-9]+/0/demistoserver-[0-9.-]+\.sh")"
    - gcloud auth revoke --all --quiet || echo "expected"
    - *create-image

build-images-ga-6.12:
  stage: build-server-images
  needs: []
  extends:
    - .build-images-ga-rule # put in comment for testing
    - .docker-job
  script:
    - gcloud auth activate-service-account --key-file $XSOAR_SERVER_STORAGE_CREDS --quiet
    - export VERSION="ga-6-12"
    - export INSTALLER_URL="xsoar-ci-artifacts-server/$(gsutil ls -d "gs://xsoar-ci-artifacts-server/server/6.12.0-[0-9]*/0/demistoserver-*.sh" | tail -n 1 | grep -o -E "server/[0-9.-]+/0/demistoserver-[0-9.-]+\.sh")"
    - gcloud auth revoke --all --quiet || echo "expected"
    - *create-image

build-images-ga-6.11:
  stage: build-server-images
  needs: []
  extends:
    - .build-images-ga-rule # put in comment for testing
    - .docker-job
  script:
    - gcloud auth activate-service-account --key-file $XSOAR_SERVER_STORAGE_CREDS --quiet
    - export VERSION="ga-6-11"
    - export INSTALLER_URL="xsoar-ci-artifacts-server/$(gsutil ls -d "gs://xsoar-ci-artifacts-server/server/6.11.0-[0-9]*/0/demistoserver-*.sh" | tail -n 1 | grep -o -E "server/[0-9.-]+/0/demistoserver-[0-9.-]+\.sh")"
    - gcloud auth revoke --all --quiet || echo "expected"
    - *create-image

build-images-dev-fan-in:
  stage: fan-in
  extends:
    - .build-images-dev-rule-always
  script:
    - echo "fan in"

build-images-dev-slack-notify:
  extends:
    - .build-images-dev-rule-always
    - .trigger-slack-notification
  variables:
    PIPELINE_TO_QUERY: $CI_PIPELINE_ID
    JOB_NAME: "build-images-dev-fan-in"
    WORKFLOW: "$BUILD_TYPE"
    SLACK_CHANNEL: 'content-infra-images'
    SLACK_JOB: 'true'
    SLACK_ALLOW_FAILURE: 'false'

build-images-ga-fan-in:
  stage: fan-in
  extends:
    - .build-images-ga-rule-always
  script:
    - echo "fan in"

build-images-ga-slack-notify:
  extends:
    - .build-images-ga-rule-always
    - .trigger-slack-notification
  variables:
    PIPELINE_TO_QUERY: $CI_PIPELINE_ID
    JOB_NAME: "build-images-ga-fan-in"
    WORKFLOW: "$BUILD_TYPE"
    SLACK_CHANNEL: 'content-infra-images'
    SLACK_JOB: 'true'
    SLACK_ALLOW_FAILURE: 'false'
