.create_image: &create-image
  - export BUILD_NUMBER=$(echo "$INSTALLER_URL" | grep -o -E "\-[0-9]+/" | grep -o -E "[0-9]+")
  - export SERVER_IMG_NAME="server-image-$VERSION-$BUILD_NUMBER-$(date -u +"%Y-%m-%d")"
  - export BASE_INSTANCE_NAME="template-$SERVER_IMG_NAME"
  - echo "installer url:"
  - echo "$INSTALLER_URL"
  - echo "image name:"
  - echo "$SERVER_IMG_NAME"
  - git checkout -B $CI_COMMIT_BRANCH $CI_COMMIT_SHA
  - docker build server-image-build -t test/server-image-build
  - ./server-image-build/run.sh

.build-server-master-images-schedule-rule:
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger)$/ && $BUILD_SERVER_MASTER_IMAGE == "true"'

.build-server-ga-images-schedule-rule:
  rules:
    - if: '$CI_PIPELINE_SOURCE =~ /^(schedule|trigger)$/ && $BUILD_SERVER_GA_IMAGE == "true"'

.docker-job:
  tags:
    - gce
  services:
    - name: docker.art.code.pan.run/build-tools--image-dind:20.10.12-dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""

Build-Server-Master-Image-job:
  stage: build-server-images
  needs: []
  extends:
    - .build-server-master-images-schedule-rule # put in comment for testing
    - .docker-job
  script:
    - gcloud auth activate-service-account --key-file $XSOAR_SERVER_STORAGE_CREDS --quiet
    - export VERSION="master"
    - export LAST_SUCCESS_BUILD_PATH=$(gsutil ls -d "gs://xsoar-ci-artifacts-server-dev/server/master-???????/0/ci_status_success" | tail -n 1 | grep -o -E "gs://xsoar-ci-artifacts-server-dev/server/master-[0-9]+/0")
    - export INSTALLER_URL="xsoar-ci-artifacts-server-dev/$(gsutil ls -d "$LAST_SUCCESS_BUILD_PATH/demistoserver-*.sh" | grep -o -E "server/master-[0-9]+/0/demistoserver-[0-9.-]+\.sh")"
    - gcloud auth revoke --all --quiet || echo "expected"
    - *create-image

Build-Server-6.6-Image-job:
  stage: build-server-images
  needs: []
  extends:
    - .build-server-ga-images-schedule-rule # put in comment for testing
    - .docker-job
  script:
    - gcloud auth activate-service-account --key-file $XSOAR_SERVER_STORAGE_CREDS --quiet
    - export VERSION="ga-6-6"
    - export INSTALLER_URL="xsoar-ci-artifacts-server/$(gsutil ls -d "gs://xsoar-ci-artifacts-server/server/6.6.0-[0-9]*/0/demistoserver-*.sh" | tail -n 1 | grep -o -E "server/[0-9.-]+/0/demistoserver-[0-9.-]+\.sh")"
    - gcloud auth revoke --all --quiet || echo "expected"
    - *create-image

Build-Server-6.5-Image-job:
  stage: build-server-images
  needs: []
  extends:
    # - .build-server-ga-images-schedule-rule # put in comment for testing
    - .docker-job
  script:
    - gcloud auth activate-service-account --key-file $XSOAR_SERVER_STORAGE_CREDS --quiet
    - export VERSION="ga-6-2"
    - export INSTALLER_URL="xsoar-ci-artifacts-server/$(gsutil ls -d "gs://xsoar-ci-artifacts-server/server/6.2.0-[0-9]*/0/demistoserver-*.sh" | tail -n 1 | grep -o -E "server/[0-9.-]+/0/demistoserver-[0-9.-]+\.sh")"
    - gcloud auth revoke --all --quiet || echo "expected"
    - *create-image
