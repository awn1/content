- name: Create temp dir
  file:
    path: "{{ download_dir }}"
    state: directory
    mode: 0755
  become: yes

- name: Adding no-proxy env variable to all processes for RHEL AMI's
  lineinfile:
    path: /etc/environment
    line: 'no_proxy=.docker.io,.docker.com,storage.googleapis.com,xsoar-registry.pan.dev,xsoar-registry-dev.web.app'
  become: yes

- name: install docker installation dependencies
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: latest

- name: adding docker repo to apt
  script: /server-image-build/resources/add_docker_repo.sh
  become: true

- name: update all packages installed on the system
  apt:
    name:
      - "*"
    state: latest
    force_apt_get: true
    autoclean: true
  become: true

- name: install docker and python installation dependencies
  apt:
    name:
      - lsof
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
      - python3
      - python3-pip
      - python3-venv
    state: latest
  become: true

- name: configure pip
  copy:
    src: /server-image-build/ci_resources/pip.conf
    dest: /etc/pip.conf
    mode: 0755
    force: yes

- name: Install proxy
  script: /server-image-build/resources/install_proxy.sh
  become: true

- name: Create mitmdump service
  template:
    src: /server-image-build/resources/mitmdump_systemd_file.service
    dest: /lib/systemd/system/mitmdump.service
    owner: root
    mode: 0600
    force: yes
  become: yes

- name: Create mitmdump executable file
  template:
    src: /server-image-build/resources/mitmproxy_starter.sh
    dest: /home/gcp-user/mitmproxy_starter.sh
    owner: root
    mode: 0111
    force: yes
  become: yes

- name: Copy git clone key
  template:
    src: /server-image-build/resources/git_id_ed25519.j2
    dest: /home/gcp-user/.ssh/git_id_ed25519
    owner: gcp-user
    group: gcp-user
    force: yes
  become: yes

- name: Copy ssh config
  template:
    src: /server-image-build/resources/ssh_config.j2
    dest: /home/gcp-user/.ssh/config
    owner: gcp-user
    group: gcp-user
    force: yes
  become: yes


- name: Create gitconfig file
  template:
    src: /server-image-build/resources/gitconfig.j2
    dest: /home/gcp-user/.gitconfig
    owner: gcp-user
    group: gcp-user
    force: yes
  become: yes

- name: Clone content-test-data
  git:
    dest: /home/gcp-user/content-test-data
    repo: "https://{{ gitlab_content_test_data_token }}@code.pan.run/xsoar/content-test-data.git"
  become_user: gcp-user
