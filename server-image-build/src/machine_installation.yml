- name: Create temp dir
  file:
    path: "{{ download_dir }}"
    state: directory
    mode: 0755
  become: yes

- name: Adding no-proxy env variable to all processes for RHEL AMI's
  lineinfile:
    path: /etc/environment
    line: 'no_proxy=.docker.io,.docker.com,storage.googleapis.com,xsoar-registry.pan.dev,xsoar-registry-dev.web.app'
  become: yes

- name: install docker installation dependencies
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: latest

- name: adding docker repo to apt
  script: /server-image-build/resources/add_docker_repo.sh
  become: true

- name: update all packages installed on the system
  apt:
    name:
      - "*"
    state: latest
    force_apt_get: true
    autoclean: true
  become: true

- name: install docker and python installation dependencies
  apt:
    name:
      - lsof
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
      - python3
      - python3-pip
      - python3-venv
    state: latest
  become: true

- name: configure pip
  copy:
    src: /server-image-build/ci_resources/pip.conf
    dest: /etc/pip.conf
    mode: 0755
    force: yes

- name: Create gitconfig file
  template:
    src: /server-image-build/resources/gitconfig.j2
    dest: /home/gcp-user/.gitconfig
    owner: gcp-user
    group: gcp-user
    force: yes
  become: yes

- name: Reinstall git to make sure that git over https will work.
  shell: "apt-get reinstall git"
  become: yes

