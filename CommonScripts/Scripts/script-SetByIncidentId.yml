commonfields:
  id: SetByIncidentId
  version: -1
name: SetByIncidentId
script: >
  register_module_line('SetByIncidentId', 'start', __line__())

  demisto.debug('pack name = Common Scripts, pack version = 1.19.29')





  def main():
      incident_id = demisto.args()['id'] if 'id' in demisto.args() else demisto.incidents()[0]['id']
      key = demisto.args()['key']
      value = demisto.args()['value']
      append = demisto.args()['append']
      error_unfinished = argToBoolean(demisto.args().get('errorUnfinished', "false"))

      args = {'key': key, 'value': value, 'append': append}

      res = demisto.executeCommand(
          'executeCommandAt',
          {
              'incidents': incident_id,
              'command': 'Set',
              'arguments': args,
          }
      )
      if error_unfinished:
          result_string = res[-1].get('Contents', "")
          result_string = result_string.strip('.')
          numbers = [int(s) for s in result_string.split() if s.isdigit()]
          if len(set(numbers)) > 1:  # check if all the numbers are the same. Supposed to be 2 numbers.
              # if the numbers are the same, Set succeed on all of the incidents.
              return_error("Not all incidents were set.\n" + result_string)

      demisto.results(res)


  if __name__ in ('__main__', '__builtin__', 'builtins'):
      main()

  register_module_line('SetByIncidentId', 'end', __line__())
type: python
subtype: python3
tags:
- DemistoAPI
comment: "Works the same as the 'Set' command, but can work across incidents by specifying 'id' as an argument.\nSets a value into the context with the given context key. Doesn't append by default.\n\nThis automation runs using the default Limited User role, unless you explicitly change the permissions.\nFor more information, see the section about permissions here:\n- For Cortex XSOAR 6 see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.x/Cortex-XSOAR-Playbook-Design-Guide/Automations \n- For Cortex XSOAR 8 Cloud see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8/Cortex-XSOAR-Cloud-Documentation/Create-a-script\n- For Cortex XSOAR 8.7 On-prem see https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/8.7/Cortex-XSOAR-On-prem-Documentation/Create-a-script"
enabled: true
args:
- name: id
  default: true
  description: Incident to set context values in (Default is current incident).
- name: key
  required: true
  description: The key to set.
- name: value
  required: true
  description: The value to set to the key. Can be an array. Usually, a dq expression.
- name: append
  auto: PREDEFINED
  predefined:
  - 'true'
  - 'false'
  description: If false then the context key will be overwritten. If set to true then the script will append to existing context key.
  defaultValue: 'false'
- name: errorUnfinished
  auto: PREDEFINED
  predefined:
  - 'true'
  - 'false'
  description: Returns an error if not all of the incidents where modified.
  defaultValue: 'false'
scripttarget: 0
tests:
- No test
fromversion: 5.0.0
dockerimage: demisto/python3:3.11.10.116949
nativeimage:
- '8.8'
- '8.6'
